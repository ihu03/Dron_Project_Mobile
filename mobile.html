<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#050a17" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Seoul ADS-B Mobile</title>
  <link rel="stylesheet" href="./leaflet.css" />
  <style>
    :root {
      --bg: #0b1224;
      --panel: rgba(9, 14, 28, 0.75);
      --text: #e9f1ff;
      --muted: #9cb2d5;
      --accent: #38bdf8;
      --warn: #f59e0b;
      --danger: #f43f5e;
    }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      width: 100%;
      background: #050a17;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      color: var(--text);
      overflow: hidden;
    }

    #map {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #050a17;
    }

    /* Dim only the map tiles (not markers/UI) */
    .leaflet-tile-pane {
      filter: brightness(0.4);
    }

    .hud {
      position: fixed;
      top: calc(env(safe-area-inset-top, 0px) + 6px);
      left: calc(env(safe-area-inset-left, 0px) + 8px);
      right: calc(env(safe-area-inset-right, 0px) + 8px);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      pointer-events: none;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 14px;
      background: var(--panel);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: var(--text);
      font-weight: 700;
      font-size: 13px;
      pointer-events: auto;
    }

    .pill .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(56, 189, 248, 0.2);
    }

    .pill.warn .dot { background: var(--warn); box-shadow: 0 0 0 6px rgba(245, 158, 11, 0.25); }
    .pill.danger .dot { background: var(--danger); box-shadow: 0 0 0 6px rgba(244, 63, 94, 0.25); }

    .pill.muted {
      color: var(--muted);
    }

    .panel {
      position: fixed;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
      left: calc(env(safe-area-inset-left, 0px) + 12px);
      right: calc(env(safe-area-inset-right, 0px) + 12px);
      padding: 12px 14px;
      border-radius: 18px;
      background: var(--panel);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 13px;
      pointer-events: none;
    }

    .panel strong { color: var(--text); }
    .panel span { color: var(--muted); }

    .panel .stat {
      display: grid;
      gap: 4px;
      min-width: 120px;
    }

    /* Plane icons */
    .plane-icon {
      display: inline-block;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.35));
      transform: translateZ(0);
      will-change: transform;
    }
    .plane-icon svg {
      display: block;
    }

    .error {
      position: fixed;
      top: 12px;
      right: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(244, 63, 94, 0.2);
      border: 1px solid rgba(244, 63, 94, 0.35);
      color: #ffdce5;
      font-weight: 700;
      display: none;
      backdrop-filter: blur(6px);
    }

    @media (max-width: 540px) {
      .panel {
        gap: 8px;
        font-size: 12px;
      }
      .pill {
        font-size: 12px;
      }
    }
  </style>
</head>
  <body>
  <div id="map"></div>
  <div class="hud">
    <div class="pill" id="status-pill">
      <span class="dot"></span>
      <span id="status-text">기체 불러오는 중...</span>
    </div>
    <div class="pill muted" id="last-updated">-</div>
  </div>
  <div class="error" id="error-box"></div>
  <div class="panel">
    <div class="stat"><span>총 기체 수</span><strong id="count-total">-</strong></div>
    <div class="stat"><span>좌표 보유</span><strong id="count-pos">-</strong></div>
    <div class="stat"><span>최근 갱신</span><strong id="ping-ms">-</strong></div>
  </div>

  <script src="./leaflet.js"></script>
  <script>
    const map = L.map("map", { worldCopyJump: true, zoomControl: false }).setView([37.5665, 126.9780], 8);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "(c) OpenStreetMap contributors",
    }).addTo(map);
    map.attributionControl.setPrefix("");

    const statusPill = document.getElementById("status-pill");
    const statusText = document.getElementById("status-text");
    const lastUpdated = document.getElementById("last-updated");
    const errorBox = document.getElementById("error-box");
    const countTotal = document.getElementById("count-total");
    const countPos = document.getElementById("count-pos");
    const pingMs = document.getElementById("ping-ms");

    const markers = new Map(); // hex -> { marker, lastSeen }
    const STALE_MS = 45000;
    const POLL_MS = 2000;

    const FT_TO_M = 0.3048;

    function altitudeMeters(ac) {
      const ft = Number.isFinite(ac?.alt_baro) ? ac.alt_baro : null;
      return ft === null ? null : ft * FT_TO_M;
    }

    function hexToRgb(hex) {
      const v = hex.replace("#", "");
      return [parseInt(v.slice(0, 2), 16), parseInt(v.slice(2, 4), 16), parseInt(v.slice(4, 6), 16)];
    }

    function lerpColor(a, b, t) {
      const clamped = Math.min(Math.max(t, 0), 1);
      const [ar, ag, ab] = hexToRgb(a);
      const [br, bg, bb] = hexToRgb(b);
      const rr = Math.round(ar + (br - ar) * clamped);
      const rg = Math.round(ag + (bg - ag) * clamped);
      const rb = Math.round(ab + (bb - ab) * clamped);
      return `#${rr.toString(16).padStart(2, "0")}${rg.toString(16).padStart(2, "0")}${rb.toString(16).padStart(2, "0")}`;
    }

    function adjustColor(hex, t = 0) {
      const [r, g, b] = hexToRgb(hex);
      const clamp = (v) => Math.min(255, Math.max(0, Math.round(v)));
      const mix = (ch) => (t >= 0 ? ch + (255 - ch) * t : ch * (1 + t));
      return `#${clamp(mix(r)).toString(16).padStart(2, "0")}${clamp(mix(g)).toString(16, "0")}${clamp(mix(b)).toString(16, "0")}`;
    }

    function altitudeToColor(ac) {
      const altM = Math.max(0, Number.isFinite(altitudeMeters(ac)) ? altitudeMeters(ac) : 0);
      const bands = [
        { max: 2000, from: adjustColor("#00A8FF", -0.15), to: adjustColor("#00A8FF", 0.25) },
        { max: 8000, from: adjustColor("#22C55E", -0.15), to: adjustColor("#22C55E", 0.25) },
        { max: Infinity, from: adjustColor("#A855F7", -0.15), to: adjustColor("#A855F7", 0.25) },
      ];
      let prevMax = 0;
      for (const band of bands) {
        if (altM <= band.max) {
          const range = band.max - prevMax;
          const t = !Number.isFinite(range) ? 0 : (altM - prevMax) / Math.max(range, 1);
          return lerpColor(band.from, band.to, t);
        }
        prevMax = band.max;
      }
      return bands[bands.length - 1].to;
    }

    function createPlaneIcon(ac, isSelected = false) {
      const heading = Number.isFinite(ac.track) ? ac.track : 0;
      const color = altitudeToColor(ac);
      const fill = isSelected ? color : color;
      const strokeAttrs = isSelected
        ? 'stroke="rgba(0,0,0,0.45)" stroke-width="1.5" stroke-linejoin="round"'
        : 'stroke="none"';
      return L.divIcon({
        className: "plane-icon",
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        html: `<svg viewBox="0 0 24 24" width="28" height="28" style="transform: rotate(${heading}deg); color:${fill};" fill="currentColor">
          <path d="M2 13l1.5-2 7-1 1-6h1l1 6 7 1 1.5 2-1.5 2-7 1-1 6h-1l-1-6-7-1z" ${strokeAttrs} />
        </svg>`
      });
    }

    function formatTime() {
      const now = new Date();
      return now.toLocaleTimeString("ko-KR", { hour12: false });
    }

    function setStatus(text, tone = "ok") {
      statusText.textContent = text;
      statusPill.classList.remove("warn", "danger");
      if (tone === "warn") statusPill.classList.add("warn");
      if (tone === "danger") statusPill.classList.add("danger");
    }

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.style.display = "block";
      setTimeout(() => (errorBox.style.display = "none"), 4000);
    }

    function haversineKm(lat1, lon1, lat2, lon2) {
      const toRad = (d) => (d * Math.PI) / 180;
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function updateMarkers(list) {
      const now = Date.now();
      const seen = new Set();

      list.forEach((ac) => {
        if (!Number.isFinite(ac.lat) || !Number.isFinite(ac.lon)) return;
        const hex = ac.hex || ac.icao || ac.id || Math.random().toString(16).slice(2, 8);
        const pos = [ac.lat, ac.lon];
        seen.add(hex);

        if (!markers.has(hex)) {
          const marker = L.marker(pos, { icon: createPlaneIcon(ac, false) }).addTo(map);
          marker.bindTooltip(`${ac.flight || ac.hex || "Unknown"}`, { direction: "top", offset: [0, -8] });
          markers.set(hex, { marker, lastSeen: now });
        } else {
          const entry = markers.get(hex);
          entry.marker.setLatLng(pos);
          entry.marker.setIcon(createPlaneIcon(ac, false));
          entry.lastSeen = now;
        }
      });

      // Remove stale markers
      markers.forEach((entry, hex) => {
        if (!seen.has(hex) && now - entry.lastSeen > STALE_MS) {
          map.removeLayer(entry.marker);
          markers.delete(hex);
        }
      });
    }

    async function poll() {
      const start = performance.now();
      try {
        const res = await fetch("/api/aircraft", { cache: "no-store" });
        const elapsed = Math.max(1, Math.round(performance.now() - start));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const list = Array.isArray(data?.aircraft) ? data.aircraft : Array.isArray(data) ? data : [];
        const withPos = list.filter((p) => Number.isFinite(p.lat) && Number.isFinite(p.lon));

        countTotal.textContent = list.length.toLocaleString("ko-KR");
        countPos.textContent = withPos.length.toLocaleString("ko-KR");
        pingMs.textContent = `${elapsed} ms`;
        lastUpdated.textContent = `업데이트: ${formatTime()}`;
        setStatus(withPos.length ? `기체 ${withPos.length.toLocaleString("ko-KR")}대 위치 표시 중` : "표시할 기체 없음", withPos.length ? "ok" : "warn");

        updateMarkers(withPos);
      } catch (e) {
        showError("데이터 불러오기 실패");
        setStatus("데이터 불러오기 실패", "danger");
      } finally {
        setTimeout(poll, POLL_MS);
      }
    }

    poll();
  </script>
</body>
</html>
